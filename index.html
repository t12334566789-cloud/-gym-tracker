<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymTracker - Твой фитнес-трекер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PWA Manifest (будет позже) -->
    <link rel="manifest" id="app-manifest">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body.dark-theme {
            --primary-color: #1a1a2e;
            --secondary-color: #162447;
            --accent-color: #e94560;
            --light-color: #0f3460;
            --dark-color: #1a1a2e;
            --success-color: #4ecca3;
            --warning-color: #ff9a3c;
            --card-bg: rgba(26, 26, 46, 0.95);
            --text-color: #f1f1f1;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('paint-background.jpg') center/cover fixed;
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ШАПКА */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            color: var(--accent-color);
            font-size: 28px;
        }

        .logo i {
            color: var(--secondary-color);
            font-size: 32px;
        }

        .theme-switch {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s;
        }

        .theme-switch:hover {
            transform: scale(1.05);
        }

        /* НАВИГАЦИЯ */
        .nav-menu {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            background: var(--light-color);
            border: none;
            border-radius: 10px;
            color: var(--text-color);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn.active {
            background: var(--secondary-color);
            color: white;
        }

        /* СТРАНИЦЫ */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* КАРТОЧКИ */
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .card h2 i {
            color: var(--accent-color);
        }

        /* ПРОФИЛЬ */
        .profile-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--secondary-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            color: #333;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        .bmi-result {
            background: var(--light-color);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* КАЛЕНДАРЬ */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: var(--light-color);
            border-radius: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .calendar-day:hover {
            background: var(--secondary-color);
            color: white;
        }

        .calendar-day.trained {
            background: var(--success-color);
            color: white;
        }

        .calendar-day.rest-day {
            background: var(--accent-color);
            color: white;
        }

        /* ЦЕЛИ */
        .goal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--light-color);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .goal-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* ДРУЗЬЯ */
        .friend-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--light-color);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .friend-avatar.stub {
            background: #95a5a6;
        }

        /* ЭКРАН ВХОДА */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), url('paint-background.jpg') center/cover;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .user-id-display {
            background: var(--light-color);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            letter-spacing: 2px;
        }

        .instructions {
            background: var(--light-color);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }

        /* СТАТИСТИКА */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--light-color);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-color);
        }

        /* УВЕДОМЛЕНИЯ PWA */
        .pwa-install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            width: 90%;
            max-width: 400px;
            display: none;
            animation: slideUp 0.3s ease;
        }

        .pwa-install-prompt.show {
            display: block;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* УВЕДОМЛЕНИЯ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.error {
            background: var(--accent-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ОФФЛАЙН СТАТУС */
        .offline-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--warning-color);
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 10001;
            display: none;
        }

        .offline-status.show {
            display: block;
        }

        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .nav-menu {
                flex-direction: column;
            }
            
            .profile-info {
                grid-template-columns: 1fr;
            }
            
            .calendar {
                grid-template-columns: repeat(4, 1fr);
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .pwa-install-prompt {
                bottom: 10px;
                width: 95%;
            }
        }

        /* ИНСТАЛЛЯЦИЯ PWA */
        .install-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--success-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px auto;
            transition: transform 0.3s;
        }

        .install-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- ОФФЛАЙН СТАТУС -->
    <div class="offline-status" id="offlineStatus">
        <i class="fas fa-wifi-slash"></i> Вы в оффлайн-режиме. Некоторые функции ограничены.
    </div>

    <!-- УВЕДОМЛЕНИЯ -->
    <div id="notificationContainer"></div>

    <!-- ПРОМПТ УСТАНОВКИ PWA -->
    <div class="pwa-install-prompt" id="pwaInstallPrompt">
        <div style="text-align: center;">
            <div style="font-size: 48px; color: var(--secondary-color); margin-bottom: 10px;">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <h3>Установить GymTracker как приложение?</h3>
            <p>Добавьте на главный экран для быстрого доступа и оффлайн-работы</p>
            <button class="install-btn" onclick="installPWA()">
                <i class="fas fa-download"></i> Установить приложение
            </button>
            <button onclick="hidePWAInstallPrompt()" style="background: transparent; color: #666; padding: 10px;">
                Не сейчас
            </button>
        </div>
    </div>

    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="logo">
                <i class="fas fa-dumbbell"></i>
                <h1>GymTracker</h1>
            </div>
            
            <h2>Вход в систему</h2>
            
            <div class="input-group">
                <label for="emailInput"><i class="fas fa-envelope"></i> Введите ваш email:</label>
                <input type="email" id="emailInput" placeholder="ваш@email.com">
            </div>
            
            <button onclick="loginByEmail()" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Войти / Зарегистрироваться
            </button>
            
            <div id="userIdDisplay" class="user-id-display" style="display: none;">
                Ваш ID: <span id="userIdValue"></span>
            </div>
            
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> Как это работает:</h3>
                <p>1. Введите ваш email</p>
                <p>2. Вы получите уникальный ID (например: GYM-7A3B)</p>
                <p>3. Этот ID нужен для поиска друзей</p>
                <p>4. Все данные сохранятся автоматически</p>
                <p>5. <strong>Можно установить как приложение!</strong></p>
            </div>
            
            <!-- Тестовые ID для быстрой проверки -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <p style="margin-bottom: 10px; font-weight: bold;"><i class="fas fa-vial"></i> Тестовые ID для проверки:</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <span style="background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-family: monospace;">GYM-7A3B</span>
                    <span style="background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-family: monospace;">GYM-8C2D</span>
                    <span style="background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-family: monospace;">GYM-9E1F</span>
                </div>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">Используйте эти ID для тестирования системы друзей</p>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <!-- ШАПКА -->
        <header>
            <div class="logo">
                <i class="fas fa-dumbbell"></i>
                <h1>GymTracker <span id="pwaBadge" style="font-size: 12px; background: var(--success-color); color: white; padding: 2px 8px; border-radius: 10px; margin-left: 10px; display: none;">PWA</span></h1>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
                <div id="currentUserId" style="background: var(--light-color); padding: 10px 15px; border-radius: 8px; font-weight: bold;">
                    ID: <span id="userDisplayId"></span>
                </div>
                <button class="theme-switch" onclick="toggleTheme()">
                    <i class="fas fa-palette"></i> Сменить тему
                </button>
                <button onclick="showInstallPrompt()" id="installBtn" style="background: var(--success-color); display: none;">
                    <i class="fas fa-download"></i> Установить
                </button>
                <button onclick="logout()" style="background: var(--accent-color);">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </header>

        <!-- НАВИГАЦИЯ -->
        <div class="nav-menu">
            <button class="nav-btn active" onclick="showPage('profile')">
                <i class="fas fa-user"></i> Профиль
            </button>
            <button class="nav-btn" onclick="showPage('calendar')">
                <i class="fas fa-calendar-alt"></i> Календарь
            </button>
            <button class="nav-btn" onclick="showPage('diary')">
                <i class="fas fa-book"></i> Дневник
            </button>
            <button class="nav-btn" onclick="showPage('friends')">
                <i class="fas fa-users"></i> Друзья
            </button>
        </div>

        <!-- СТРАНИЦА 1: ПРОФИЛЬ -->
        <div id="profilePage" class="page active">
            <div class="card">
                <h2><i class="fas fa-user"></i> Мой профиль</h2>
                <div class="profile-info">
                    <div>
                        <div class="input-group">
                            <label for="userEmail">Email:</label>
                            <input type="email" id="userEmail" disabled>
                        </div>
                        
                        <div class="input-group">
                            <label for="userName">Имя:</label>
                            <input type="text" id="userName" placeholder="Ваше имя">
                        </div>
                        
                        <div class="input-group">
                            <label for="userAge">Возраст:</label>
                            <input type="number" id="userAge" placeholder="Возраст">
                        </div>
                    </div>
                    
                    <div>
                        <div class="input-group">
                            <label for="userHeight">Рост (см):</label>
                            <input type="number" id="userHeight" placeholder="Рост в см">
                        </div>
                        
                        <div class="input-group">
                            <label for="userWeight">Вес (кг):</label>
                            <input type="number" id="userWeight" placeholder="Вес в кг">
                        </div>
                        
                        <button onclick="calculateBMI()">
                            <i class="fas fa-calculator"></i> Рассчитать ИМТ
                        </button>
                        
                        <div id="bmiResult" class="bmi-result">
                            ИМТ: -- | Категория: --
                        </div>
                    </div>
                </div>
                <button onclick="saveProfile()" style="margin-top: 15px;">
                    <i class="fas fa-save"></i> Сохранить профиль
                </button>
            </div>

            <!-- ЦЕЛИ НА СТРАНИЦЕ ПРОФИЛЯ -->
            <div class="card">
                <h2><i class="fas fa-flag-checkered"></i> Мои цели</h2>
                <div id="goalsList">
                    <!-- Цели будут здесь -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <input type="text" id="newGoal" placeholder="Новая цель">
                    <button onclick="addGoal()">
                        <i class="fas fa-plus"></i> Добавить
                    </button>
                </div>
            </div>

            <!-- СТАТИСТИКА НА СТРАНИЦЕ ПРОФИЛЯ -->
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> Статистика</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><i class="fas fa-dumbbell"></i> Тренировок</h3>
                        <div class="stat-value" id="workoutsCount">0</div>
                        <p>в этом месяце</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-flag-checkered"></i> Целей</h3>
                        <div class="stat-value" id="goalsCompleted">0</div>
                        <p>выполнено</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-users"></i> Друзей</h3>
                        <div class="stat-value" id="friendsCount">0</div>
                        <p>в сети</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-heartbeat"></i> ИМТ</h3>
                        <div class="stat-value" id="currentBMI">--</div>
                        <p id="bmiCategoryText">не рассчитан</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- СТРАНИЦА 2: КАЛЕНДАРЬ -->
        <div id="calendarPage" class="page">
            <div class="card">
                <h2><i class="fas fa-calendar-alt"></i> Календарь тренировок</h2>
                <p>Кликните на день, чтобы отметить тренировку</p>
                
                <div class="calendar" id="calendar">
                    <!-- Дни календаря будут здесь -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button onclick="markAsTrained()">
                        <i class="fas fa-dumbbell"></i> Сегодня тренировался
                    </button>
                    <button onclick="markAsRest()" style="background: var(--accent-color);">
                        <i class="fas fa-bed"></i> Сегодня отдыхал
                    </button>
                    <button onclick="prevMonth()" style="background: var(--light-color); color: var(--text-color);">
                        <i class="fas fa-chevron-left"></i> Предыдущий месяц
                    </button>
                    <button onclick="nextMonth()" style="background: var(--light-color); color: var(--text-color);">
                        <i class="fas fa-chevron-right"></i> Следующий месяц
                    </button>
                    <button onclick="clearCalendar()" style="background: var(--warning-color);">
                        <i class="fas fa-trash"></i> Очистить месяц
                    </button>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-info-circle"></i> Легенда календаря</h2>
                <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; background: var(--success-color); border-radius: 5px;"></div>
                        <span>Тренировка</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; background: var(--accent-color); border-radius: 5px;"></div>
                        <span>Отдых</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; background: var(--light-color); border-radius: 5px; border: 2px solid var(--accent-color);"></div>
                        <span>Сегодня</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- СТРАНИЦА 3: ДНЕВНИК -->
        <div id="diaryPage" class="page">
            <div class="card">
                <h2><i class="fas fa-book"></i> Дневник тренировок</h2>
                <div class="input-group">
                    <label for="workoutNotes">Заметки о сегодняшней тренировке:</label>
                    <textarea id="workoutNotes" rows="6" placeholder="Что делал, как самочувствие, результаты, продолжительность, самооценка..."></textarea>
                </div>
                <button onclick="saveWorkoutNotes()" style="margin-top: 10px;">
                    <i class="fas fa-save"></i> Сохранить заметки
                </button>
            </div>

            <div class="card">
                <h2><i class="fas fa-history"></i> Предыдущие записи</h2>
                <div id="savedNotes">
                    <!-- Заметки будут здесь -->
                </div>
                <div id="noNotesMessage" style="text-align: center; padding: 30px; color: #666;">
                    <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p>У вас пока нет записей в дневнике</p>
                    <p>Начните вести записи о своих тренировках!</p>
                </div>
            </div>
        </div>

        <!-- СТРАНИЦА 4: ДРУЗЬЯ -->
        <div id="friendsPage" class="page">
            <div class="card">
                <h2><i class="fas fa-users"></i> Мои друзья</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" id="friendIdInput" placeholder="Введите ID друга (GYM-XXXX)" style="flex-grow: 1;">
                    <button onclick="addFriendById()">
                        <i class="fas fa-search"></i> Найти и добавить
                    </button>
                </div>
                
                <div style="background: var(--light-color); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p><strong><i class="fas fa-info-circle"></i> Ваш ID для друзей:</strong></p>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px; font-family: monospace; font-size: 18px; font-weight: bold; text-align: center; color: var(--accent-color);">
                        <span id="myIdForFriends"></span>
                    </div>
                    <p style="margin-top: 10px; font-size: 14px;">Покажите этот ID друзьям, чтобы они могли добавить вас</p>
                    
                    <!-- Тестовые ID для быстрой проверки -->
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                        <p style="margin-bottom: 5px; font-weight: bold; font-size: 14px;"><i class="fas fa-vial"></i> Тестовые ID для проверки:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <button onclick="document.getElementById('friendIdInput').value = 'GYM-7A3B'" style="padding: 5px 10px; background: white; border: 1px solid #ccc; border-radius: 3px; font-family: monospace; font-size: 12px; cursor: pointer;">
                                GYM-7A3B
                            </button>
                            <button onclick="document.getElementById('friendIdInput').value = 'GYM-8C2D'" style="padding: 5px 10px; background: white; border: 1px solid #ccc; border-radius: 3px; font-family: monospace; font-size: 12px; cursor: pointer;">
                                GYM-8C2D
                            </button>
                            <button onclick="document.getElementById('friendIdInput').value = 'GYM-9E1F'" style="padding: 5px 10px; background: white; border: 1px solid #ccc; border-radius: 3px; font-family: monospace; font-size: 12px; cursor: pointer;">
                                GYM-9E1F
                            </button>
                        </div>
                        <p style="margin-top: 5px; font-size: 12px; color: #666;">Кликните, чтобы быстро вставить ID</p>
                    </div>
                </div>
                
                <div id="friendsList">
                    <!-- Друзья будут здесь -->
                </div>
                
                <div id="noFriendsMessage" style="text-align: center; padding: 30px; color: #666;">
                    <i class="fas fa-user-friends" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p>У вас пока нет друзей</p>
                    <p>Добавьте друзей по их ID, чтобы видеть их прогресс!</p>
                    <button onclick="addTestFriends()" style="margin-top: 15px; background: var(--warning-color);">
                        <i class="fas fa-vial"></i> Добавить тестовых друзей
                    </button>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-question-circle"></i> Как добавить друга</h2>
                <div class="instructions">
                    <p>1. Попросите друга зайти в его GymTracker</p>
                    <p>2. На странице "Друзья" он увидит свой ID</p>
                    <p>3. Он должен сообщить вам этот ID (формат: GYM-XXXX)</p>
                    <p>4. Введите этот ID в поле выше и нажмите "Найти и добавить"</p>
                    <p>5. После этого вы увидите друг друга в списке друзей</p>
                    <p><strong>Для теста используйте ID: GYM-7A3B, GYM-8C2D, GYM-9E1F</strong></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
        let currentUser = null;
        let allUsers = {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let deferredPrompt = null;
        let isPWAInstalled = false;

        // ==================== PWA ФУНКЦИИ ====================
        
        // Инициализация PWA
        function initPWA() {
            // Проверяем, установлено ли уже как PWA
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                isPWAInstalled = true;
                document.getElementById('pwaBadge').style.display = 'inline';
                document.getElementById('installBtn').style.display = 'none';
                console.log('Запущено как PWA');
            }
            
            // Создаём манифест динамически
            createManifest();
            
            // Регистрируем Service Worker
            registerServiceWorker();
            
            // Отслеживаем событие "до установки"
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'flex';
                console.log('PWA может быть установлено');
                
                // Показываем промпт через 5 секунд после входа
                setTimeout(() => {
                    if (!isPWAInstalled && deferredPrompt) {
                        showPWAInstallPrompt();
                    }
                }, 5000);
            });
            
            // Отслеживаем установку
            window.addEventListener('appinstalled', () => {
                isPWAInstalled = true;
                document.getElementById('pwaBadge').style.display = 'inline';
                document.getElementById('installBtn').style.display = 'none';
                hidePWAInstallPrompt();
                showNotification('GymTracker установлен как приложение!', 'success');
                console.log('PWA установлено');
            });
            
            // Отслеживаем онлайн/оффлайн статус
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }
        
        // Создание манифеста
        function createManifest() {
            const manifest = {
                "name": "GymTracker",
                "short_name": "GymTracker",
                "description": "Твой фитнес-трекер с календарём тренировок, ИМТ и друзьями",
                "start_url": "/",
                "display": "standalone",
                "background_color": "#2c3e50",
                "theme_color": "#3498db",
                "icons": [
                    {
                        "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTAwIiBmaWxsPSIjMzQ5OERCIi8+CjxwYXRoIGQ9Ik0zNTIgMjQwSDE2MHYzMmgxOTJ2MzJIMTYwdjMyaDE5MnYzMkgxNjB2MzJoMTkyVjM1MkgxNjBWMzIwSDEyOFYyNzJIMTYwVjI0MEgxMjhWMTkySDE2MFYxNjBIMTI4VjEyOEgxNjBWOEgxOTJWMTI4SDM1MlYxNjBIMTkyVjE5MkgzNTJWMjQwWiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==",
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.getElementById('app-manifest').href = manifestURL;
        }
        
        // Регистрация Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('Service Worker зарегистрирован:', registration);
                }).catch(error => {
                    console.log('Ошибка регистрации Service Worker:', error);
                });
            }
        }
        
        // Показать промпт установки
        function showPWAInstallPrompt() {
            if (deferredPrompt && !isPWAInstalled) {
                document.getElementById('pwaInstallPrompt').classList.add('show');
            }
        }
        
        function hidePWAInstallPrompt() {
            document.getElementById('pwaInstallPrompt').classList.remove('show');
        }
        
        // Установка PWA
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Пользователь принял установку');
                    } else {
                        console.log('Пользователь отклонил установку');
                    }
                    deferredPrompt = null;
                });
            }
            hidePWAInstallPrompt();
        }
        
        function showInstallPrompt() {
            showPWAInstallPrompt();
        }
        
        // Обновление онлайн статуса
        function updateOnlineStatus() {
            const offlineStatus = document.getElementById('offlineStatus');
            if (!navigator.onLine) {
                offlineStatus.classList.add('show');
                showNotification('Вы перешли в оффлайн-режим', 'warning');
            } else {
                offlineStatus.classList.remove('show');
            }
        }

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadAllUsers();
            checkActiveSession();
            showLoginScreen();
            initPWA(); // Инициализируем PWA
        });

        // ==================== СИСТЕМА EMAIL/ID ====================
        
        function generateUserId() {
            const chars = '0123456789ABCDEF';
            let id = 'GYM-';
            for (let i = 0; i < 4; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        }

        function findUserByEmail(email) {
            return allUsers[email];
        }

        function loginByEmail() {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim().toLowerCase();
            
            if (!email) {
                showNotification('Пожалуйста, введите email', 'error');
                return;
            }
            
            if (!email.includes('@') || !email.includes('.')) {
                showNotification('Пожалуйста, введите корректный email', 'error');
                return;
            }
            
            let user = findUserByEmail(email);
            
            if (!user) {
                user = {
                    email: email,
                    id: generateUserId(),
                    name: '',
                    age: '',
                    height: '',
                    weight: '',
                    bmi: null,
                    bmiCategory: '',
                    goals: [
                        {text: 'Тренироваться 3 раза в неделю', completed: false},
                        {text: 'Пить 2 литра воды в день', completed: false},
                        {text: 'Спать 8 часов в сутки', completed: false}
                    ],
                    friends: [],
                    calendar: {},
                    workoutNotes: {},
                    theme: 'light'
                };
                
                allUsers[email] = user;
                saveAllUsers();
                
                document.getElementById('userIdValue').textContent = user.id;
                document.getElementById('userIdDisplay').style.display = 'block';
                
                showNotification(`Добро пожаловать! Ваш ID: ${user.id}`, 'success');
            } else {
                document.getElementById('userIdValue').textContent = user.id;
                document.getElementById('userIdDisplay').style.display = 'block';
                showNotification(`С возвращением, ${user.name || 'друг'}!`, 'success');
            }
            
            currentUser = user;
            localStorage.setItem('currentUserEmail', email);
            
            setTimeout(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadUserData();
                
                if (user.theme === 'dark') {
                    document.body.classList.add('dark-theme');
                }
                
                showPage('profile');
                
                // Показываем промпт установки через 3 секунды
                setTimeout(() => {
                    if (!isPWAInstalled && deferredPrompt) {
                        showPWAInstallPrompt();
                    }
                }, 3000);
            }, 800);
        }

        // ==================== УПРАВЛЕНИЕ ДАННЫМИ ====================
        
        function saveAllUsers() {
            localStorage.setItem('gymTrackerUsers', JSON.stringify(allUsers));
        }

        function loadAllUsers() {
            const saved = localStorage.getItem('gymTrackerUsers');
            if (saved) {
                allUsers = JSON.parse(saved);
            }
        }

        function checkActiveSession() {
            const savedEmail = localStorage.getItem('currentUserEmail');
            if (savedEmail && allUsers[savedEmail]) {
                currentUser = allUsers[savedEmail];
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadUserData();
                
                if (currentUser.theme === 'dark') {
                    document.body.classList.add('dark-theme');
                }
                
                showPage('profile');
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('emailInput').value = '';
            document.getElementById('userIdDisplay').style.display = 'none';
        }

        // ==================== СИСТЕМА СТРАНИЦ ====================
        
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(pageName + 'Page').classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.textContent.includes(getPageName(pageName))) {
                    btn.classList.add('active');
                }
            });
            
            if (pageName === 'calendar') {
                generateCalendar();
            } else if (pageName === 'friends') {
                loadFriends();
            }
        }

        function getPageName(pageId) {
            const pages = {
                'profile': 'Профиль',
                'calendar': 'Календарь',
                'diary': 'Дневник',
                'friends': 'Друзья'
            };
            return pages[pageId] || pageId;
        }

        // ==================== ЗАГРУЗКА ДАННЫХ ПОЛЬЗОВАТЕЛЯ ====================
        
        function loadUserData() {
            if (!currentUser) return;
            
            document.getElementById('userEmail').value = currentUser.email;
            document.getElementById('userName').value = currentUser.name || '';
            document.getElementById('userAge').value = currentUser.age || '';
            document.getElementById('userHeight').value = currentUser.height || '';
            document.getElementById('userWeight').value = currentUser.weight || '';
            
            document.getElementById('userDisplayId').textContent = currentUser.id;
            document.getElementById('myIdForFriends').textContent = currentUser.id;
            
            if (currentUser.bmi) {
                document.getElementById('bmiResult').innerHTML = `
                    ИМТ: ${currentUser.bmi.toFixed(1)} | Категория: ${currentUser.bmiCategory}
                `;
                document.getElementById('currentBMI').textContent = currentUser.bmi.toFixed(1);
                document.getElementById('bmiCategoryText').textContent = currentUser.bmiCategory;
            }
            
            loadGoals();
            loadFriends();
            generateCalendar();
            loadWorkoutNotes();
            updateStats();
        }

        // ==================== ПРОФИЛЬ И ИМТ ====================
        
        function saveProfile() {
            if (!currentUser) return;
            
            currentUser.name = document.getElementById('userName').value;
            currentUser.age = document.getElementById('userAge').value;
            currentUser.height = document.getElementById('userHeight').value;
            currentUser.weight = document.getElementById('userWeight').value;
            
            allUsers[currentUser.email] = currentUser;
            saveAllUsers();
            
            showNotification('Профиль сохранён!', 'success');
            updateStats();
        }

        function calculateBMI() {
            const height = parseFloat(document.getElementById('userHeight').value);
            const weight = parseFloat(document.getElementById('userWeight').value);
            
            if (!height || !weight) {
                showNotification('Пожалуйста, введите рост и вес', 'error');
                return;
            }
            
            const heightInMeters = height / 100;
            const bmi = weight / (heightInMeters * heightInMeters);
            
            let category = '';
            if (bmi < 18.5) category = 'Недостаточный вес';
            else if (bmi < 25) category = 'Нормальный вес';
            else if (bmi < 30) category = 'Избыточный вес';
            else category = 'Ожирение';
            
            currentUser.bmi = bmi;
            currentUser.bmiCategory = category;
            
            document.getElementById('bmiResult').innerHTML = `
                ИМТ: ${bmi.toFixed(1)} | Категория: ${category}
            `;
            document.getElementById('currentBMI').textContent = bmi.toFixed(1);
            document.getElementById('bmiCategoryText').textContent = category;
            
            allUsers[currentUser.email] = currentUser;
            saveAllUsers();
            updateStats();
            
            showNotification(`ИМТ рассчитан: ${bmi.toFixed(1)} (${category})`, 'success');
        }

        // ==================== СИСТЕМА ЦЕЛЕЙ ====================
        
        function loadGoals() {
            const goalsList = document.getElementById('goalsList');
            goalsList.innerHTML = '';
            
            if (!currentUser.goals) {
                currentUser.goals = [];
            }
            
            if (currentUser.goals.length === 0) {
                goalsList.innerHTML = '<p style="text-align: center; padding: 20px;">Целей пока нет. Добавьте первую!</p>';
                return;
            }
            
            currentUser.goals.forEach((goal, index) => {
                const goalItem = document.createElement('div');
                goalItem.className = 'goal-item';
                goalItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" class="goal-checkbox" ${goal.completed ? 'checked' : ''} 
                               onchange="toggleGoal(${index})">
                        <span style="${goal.completed ? 'text-decoration: line-through; opacity: 0.7;' : ''}">
                            ${goal.text}
                        </span>
                    </div>
                    <button onclick="removeGoal(${index})" style="background: var(--accent-color); padding: 5px 10px;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                goalsList.appendChild(goalItem);
            });
            
            updateStats();
        }

        function addGoal() {
            const newGoalInput = document.getElementById('newGoal');
            const goalText = newGoalInput.value.trim();
            
            if (!goalText) {
                showNotification('Введите текст цели', 'error');
                return;
            }
            
            if (!currentUser.goals) {
                currentUser.goals = [];
            }
            
            currentUser.goals.push({
                text: goalText,
                completed: false
            });
            
            newGoalInput.value = '';
            
            allUsers[currentUser.email] = currentUser;
            saveAllUsers();
            loadGoals();
            
            showNotification('Цель добавлена!', 'success');
        }

        function toggleGoal(index) {
            currentUser.goals[index].completed = !currentUser.goals[index].completed;
            allUsers[currentUser.email] = currentUser;
            saveAllUsers();
            loadGoals();
            
            const goal = currentUser.goals[index];
            if (goal.completed) {
                showNotification(`Цель выполнена: "${goal.text}"`, 'success');
            }
        }

        function removeGoal(index) {
            if (confirm('Удалить эту цель?')) {
                currentUser.goals.splice(index, 1);
                allUsers[currentUser.email] = currentUser;
                saveAllUsers();
                loadGoals();
                
                showNotification('Цель удалена', 'warning');
            }
        }

        // ==================== ИСПРАВЛЕННАЯ СИСТЕМА ДРУЗЕЙ ====================
        
        // Тестовые пользователи для демонстрации
        function getSystemTestUsers() {
            return [
                {
                    id: "GYM-7A3B",
                    email: "alexey@example.com",
                    name: "Алексей",
                    height: "180",
                    weight: "75",
                    bmi: 23.1,
                    bmiCategory: "Нормальный вес",
                    goals: [
                        {text: 'Бегать 3 раза в неделю', completed: true},
                        {text: 'Подтягиваться 20 раз', completed: false}
                    ]
                },
                {
                    id: "GYM-8C2D",
                    email: "maria@example.com", 
                    name: "Мария",
                    height: "165",
                    weight: "60",
                    bmi: 22.0,
                    bmiCategory: "Нормальный вес",
                    goals: [
                        {text: 'Йога каждый день', completed: true},
                        {text: 'Пить 2л воды', completed: true}
                    ]
                },
                {
                    id: "GYM-9E1F",
                    email: "dmitry@example.com",
                    name: "Дмитрий",
                    height: "175",
                    weight: "80",
                    bmi: 26.1,
                    bmiCategory: "Избыточный вес",
                    goals: [
                        {text: 'Похудеть на 5кг', completed: false},
                        {text: 'Тренажёрный зал 4 раза', completed: true}
                    ]
                }
            ];
        }

        // Поиск друга по ID
        function findFriendById(friendId) {
            friendId = friendId.trim().toUpperCase();
            
            console.log("🔍 Ищем друга с ID:", friendId);
            
            // 1. Ищем в локальной базе
            for (const email in allUsers) {
                if (allUsers[email].id === friendId) {
                    console.log("✅ Нашли локально:", allUsers[email].name);
                    return {
                        ...allUsers[email],
                        isRealUser: true
                    };
                }
            }
            
            // 2. Проверяем системных тестовых пользователей
            const systemUsers = getSystemTestUsers();
            for (const user of systemUsers) {
                if (user.id === friendId) {
                    console.log("✅ Нашли в системных пользователях:", user.name);
                    return {
                        ...user,
                        isRealUser: true,
                        isSystemUser: true
                    };
                }
            }
            
            // 3. Создаём заглушку
            console.log("⚠️ Создаём заглушку для ID:", friendId);
            return createStubUser(friendId);
        }

        // Создание заглушки для пользователя
        function createStubUser(friendId) {
            const stubEmail = `user_${friendId.toLowerCase().replace('gym-', '')}@gymtracker.com`;
            
            return {
                id: friendId,
                email: stubEmail,
                name: `Пользователь ${friendId}`,
                height: "",
                weight: "",
                bmi: null,
                bmiCategory: "",
                isRealUser: false,
                isStub: true
            };
        }

        // Функция добавления тестовых друзей (для быстрой проверки)
        function addTestFriends() {
            const systemUsers = getSystemTestUsers();
            let addedCount = 0;
            
            systemUsers.forEach(user => {
                // Проверяем, не добавлен ли уже
                if (currentUser.friends) {
                    const alreadyAdded = currentUser.friends.find(f => f.id === user.id);
                    if (alreadyAdded) return;
                }
                
                if (!currentUser.friends) {
                    currentUser.friends = [];
                }
                
                currentUser.friends.push({
                    id: user.id,
                    email: user.email,
                    name: user.name,
                    isRealUser: true,
                    isSystemUser: true
                });
                
                addedCount++;
            });
            
            if (addedCount > 0) {
                allUsers[currentUser.email] = currentUser;
                saveAllUsers();
                loadFriends();
                showNotification(`Добавлено ${addedCount} тестовых друга`, 'success');
            } else {
                showNotification('Все тестовые друзья уже добавлены', 'warning');
            }
        }

        // Улучшенная функция добавления друга
        function addFriendById() {
            const friendIdInput = document.getElementById('friendIdInput');
            const friendId = friendIdInput.value.trim().toUpperCase();
            
            if (!friendId) {
                showNotification('Введите ID друга', 'error');
                return;
            }
            
            if (!friendId.startsWith('GYM-') || friendId.length !== 8) {
                showNotification('ID должен быть в формате GYM-XXXX (например: GYM-7A3B)', 'error');
                return;
            }
            
            if (friendId === currentUser.id) {
                showNotification('Нельзя добавить самого себя в друзья', 'error');
                return;
            }
            
            if (currentUser.friends) {
                const alreadyAdded = currentUser.friends.find(f => f.id === friendId);
                if (alreadyAdded) {
                    showNotification('Этот пользователь уже в вашем списке друзей', 'warning');
                    return;
                }
            }
            
            // Показываем анимацию поиска
            friendIdInput.placeholder = "🔍 Ищем пользователя...";
            friendIdInput.disabled = true;
            
            setTimeout(() => {
                const friend = findFriendById(friendId);
                
                friendIdInput.placeholder = "Введите ID друга (GYM-XXXX)";
                friendIdInput.disabled = false;
                
                if (!friend) {
                    showNotification('Пользователь с таким ID не найден', 'error');
                    return;
                }
                
                const confirmText = friend.isStub ? 
                    `Пользователь с ID ${friendId} ещё не синхронизировался.\n\nДобавить в ожидание? Когда он зайдёт в приложение, вы увидите его данные.` :
                    `Добавить пользователя?\n\nИмя: ${friend.name}\nID: ${friend.id}\nEmail: ${friend.email}`;
                
                if (!confirm(confirmText)) return;
                
                if (!currentUser.friends) {
                    currentUser.friends = [];
                }
                
                currentUser.friends.push({
                    id: friend.id,
                    email: friend.email,
                    name: friend.name,
                    isRealUser: friend.isRealUser || false,
                    isSystemUser: friend.isSystemUser || false,
                    isStub: friend.isStub || false
                });
                
                friendIdInput.value = '';
                
                allUsers[currentUser.email] = currentUser;
                saveAllUsers();
                loadFriends();
                
                const message = friend.isStub ? 
                    `Пользователь ${friendId} добавлен в ожидание` :
                    `Друг ${friend.name} добавлен!`;
                
                showNotification(message, 'success');
                
            }, 800);
        }

        // Загрузка списка друзей
        function loadFriends() {
            const friendsList = document.getElementById('friendsList');
            const noFriendsMessage = document.getElementById('noFriendsMessage');
            friendsList.innerHTML = '';
            
            if (!currentUser.friends || currentUser.friends.length === 0) {
                noFriendsMessage.style.display = 'block';
                return;
            }
            
            noFriendsMessage.style.display = 'none';
            
            currentUser.friends.forEach((friend, index) => {
                const friendCard = document.createElement('div');
                friendCard.className = 'friend-card';
                
                const avatarClass = friend.isStub ? 'friend-avatar stub' : 
                                  friend.isSystemUser ? 'friend-avatar' : 'friend-avatar';
                
                const statusText = friend.isStub ? 
                    '<p style="color: #e74c3c; font-size: 12px;"><i class="fas fa-clock"></i> Ожидает синхронизации</p>' :
                    friend.isSystemUser ? 
                    '<p style="color: #2ecc71; font-size: 12px;"><i class="fas fa-check-circle"></i> Тестовый пользователь</p>' :
                    '<p style="color: #3498db; font-size: 12px;"><i class="fas fa-user-check"></i> Настоящий пользователь</p>';
                
                friendCard.innerHTML = `
                    <div class="${avatarClass}">
                        <i class="fas fa-user"></i>
                    </div>
                    <div style="flex-grow: 1;">
                        <h3>${friend.name}</h3>
                        <p><strong>ID:</strong> ${friend.id}</p>
                        <p><strong>Email:</strong> ${friend.email}</p>
                        ${statusText}
                    </div>
                    <button onclick="showFriendDetails(${index})" style="background: var(--secondary-color); margin-right: 5px;">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="removeFriend(${index})" style="background: var(--accent-color);">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                friendsList.appendChild(friendCard);
            });
            
            updateStats();
        }

        // Показать детали друга
        function showFriendDetails(index) {
            const friend = currentUser.friends[index];
            
            let details = `👤 ${friend.name}\n\n`;
            details += `🆔 ID: ${friend.id}\n`;
            details += `📧 Email: ${friend.email}\n`;
            
            if (friend.isSystemUser) {
                details += `\n📊 Статистика тестового пользователя:\n`;
                details += `📏 Рост: ${friend.height || 'Нет данных'} см\n`;
                details += `⚖️ Вес: ${friend.weight || 'Нет данных'} кг\n`;
                if (friend.bmi) {
                    details += `📈 ИМТ: ${friend.bmi} (${friend.bmiCategory})\n`;
                }
                details += `\n🎯 Цели:\n`;
                if (friend.goals) {
                    friend.goals.forEach(goal => {
                        details += `  ${goal.completed ? '✅' : '⭕'} ${goal.text}\n`;
                    });
                }
            } else if (friend.isStub) {
                details += `\n⚠️ Этот пользователь ещё не заходил в приложение.\n`;
                details += `Когда он откроет GymTracker, вы увидите его данные.`;
            } else {
                details += `\n✅ Пользователь найден в системе`;
            }
            
            alert(details);
        }

        function removeFriend(index) {
            if (confirm('Удалить этого друга из списка?')) {
                const friendName = currentUser.friends[index].name;
                currentUser.friends.splice(index, 1);
                allUsers[currentUser.email] = currentUser;
                saveAllUsers();
                loadFriends();
                
                showNotification(`Друг ${friendName} удалён`, 'warning');
            }
        }

        // ==================== КАЛЕНДАРЬ ТРЕНИРОВОК ====================
        
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            document.querySelector('#calendarPage h2').innerHTML = `<i class="fas fa-calendar-alt"></i> Календарь тренировок - ${monthNames[currentMonth]} ${currentYear}`;
            
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const startingDay = firstDay.getDay();
            let startingIndex = startingDay === 0 ? 6 : startingDay - 1;
            
            for (let i = 0; i < startingIndex; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendar.appendChild(emptyDay);
            }
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            if (!currentUser.calendar) {
                currentUser.calendar = {};
            }
            
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            if (!currentUser.calendar[monthKey]) {
                currentUser.calendar[monthKey] = {};
            }
            
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dayKey = String(day).padStart(2, '0');
                const dayStatus = currentUser.calendar[monthKey][dayKey];
                
                if (dayStatus === 'trained') {
                    dayElement.classList.add('trained');
                } else if (dayStatus === 'rest') {
                    dayElement.classList.add('rest-day');
                }
                
                if (isCurrentMonth && day === today.getDate()) {
                    dayElement.style.border = '3px solid var(--accent-color)';
                }
                
                dayElement.onclick = () => toggleDayStatus(day);
                
                calendar.appendChild(dayElement);
            }
            
            updateStats();
        }

        function toggleDayStatus(day) {
            if (!currentUser.calendar) {
                currentUser.calendar = {};
            }
            
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const dayKey = String(day).padStart(2, '0');
            
            if (!currentUser.calendar[monthKey]) {
                currentUser.calendar[monthKey] = {};
            }
            
            const currentStatus = currentUser.calendar[monthKey][dayKey];
            
            if (!currentStatus || currentStatus === 'none') {
                currentUser.calendar[monthKey][dayKey] = 'trained';
                showNotification(`Тренировка ${day}.${currentMonth + 1} отмечена!`, 'success');
            } else if (currentStatus === 'trained') {
                currentUser.calendar[monthKey][dayKey] = 'rest';
                showNotification(`Отдых ${day}.${currentMonth + 1} отмечен`, 'warning');
            } else {
                currentUser.calendar[monthKey][dayKey] = 'none';
                showNotification(`День ${day}.${currentMonth + 1} очищен`, 'warning');
            }
            
            allUsers[currentUser.email] = currentUser;
            saveAllUsers();
            generateCalendar();
        }

        function markAsTrained() {
            const today = new Date();
            if (today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                toggleDayStatus(today.getDate());
            } else {
                showNotification('Сегодняшний день не в текущем месяце календаря', 'error');
            }
        }

        function markAsRest() {
            const today = new Date();
            if (today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                const day = today.getDate();
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const dayKey = String(day).padStart(2, '0');
                
                if (!currentUser.calendar) currentUser.calendar = {};
                if (!currentUser.calendar[monthKey]) currentUser.calendar[monthKey] = {};
                
                currentUser.calendar[monthKey][dayKey] = 'rest';
                
                allUsers[currentUser.email] = currentUser;
                saveAllUsers();
                generateCalendar();
                
                showNotification('Отдых отмечен на сегодня', 'warning');
            }
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
            showNotification(`Перешли к ${getMonthName(currentMonth)} ${currentYear}`, 'success');
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar();
            showNotification(`Перешли к ${getMonthName(currentMonth)} ${currentYear}`, 'success');
        }

        function getMonthName(month) {
            const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            return months[month];
        }

        function clearCalendar() {
            if (confirm('Вы уверены, что хотите очистить календарь на этот месяц?')) {
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                currentUser.calendar[monthKey] = {};
                
                allUsers[currentUser.email] = currentUser;
                saveAllUsers();
                generateCalendar();
                
                showNotification('Календарь очищен', 'warning');
            }
        }

        // ==================== ДНЕВНИК ТРЕНИРОВОК ====================
        
        function loadWorkoutNotes() {
            const savedNotes = document.getElementById('savedNotes');
            const noNotesMessage = document.getElementById('noNotesMessage');
            savedNotes.innerHTML = '';
            
            if (!currentUser.workoutNotes) {
                currentUser.workoutNotes = {};
            }
            
            const notes = Object.entries(currentUser.workoutNotes)
                .sort((a, b) => b[0].localeCompare(a[0]));
            
            if (notes.length === 0) {
                noNotesMessage.style.display = 'block';
                return;
            }
            
            noNotesMessage.style.display = 'none';
            
            notes.forEach(([date, note]) => {
                const noteElement = document.createElement('div');
                noteElement.className = 'goal-item';
                noteElement.style.marginTop = '10px';
                noteElement.innerHTML = `
                    <div style="flex-grow: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <strong>${formatDate(date)}</strong>
                            <span style="font-size: 12px; color: #666;">${date}</span>
                        </div>
                        <p style="white-space: pre-wrap;">${note}</p>
                    </div>
                    <button onclick="deleteNote('${date}')" style="background: var(--accent-color); padding: 5px 10px; align-self: flex-start;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                savedNotes.appendChild(noteElement);
            });
        }

        function saveWorkoutNotes() {
            const notesInput = document.getElementById('workoutNotes');
            const notes = notesInput.value.trim();
            
            if (!notes) {
                showNotification('Введите заметки о тренировке', 'error');
                return;
            }
            
            if (!currentUser.workoutNotes) {
                currentUser.workoutNotes = {};
            }
            
            const today = new Date().toISOString().split('T')[0];
            currentUser.workoutNotes[today] = notes;
            
            notesInput.value = '';
            
            allUsers[currentUser.email] = currentUser;
            saveAllUsers();
            loadWorkoutNotes();
            
            showNotification('Заметки сохранены!', 'success');
        }

        function deleteNote(date) {
            if (confirm('Удалить эту заметку?')) {
                delete currentUser.workoutNotes[date];
                allUsers[currentUser.email] = currentUser;
                saveAllUsers();
                loadWorkoutNotes();
                
                showNotification('Заметка удалена', 'warning');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // ==================== ТЕМЫ И ВЫХОД ====================
        
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            
            if (currentUser) {
                currentUser.theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                allUsers[currentUser.email] = currentUser;
                saveAllUsers();
            }
            
            showNotification(`Тема изменена: ${document.body.classList.contains('dark-theme') ? 'Тёмная' : 'Светлая'}`, 'success');
        }

        function logout() {
            if (confirm('Выйти из аккаунта?')) {
                localStorage.removeItem('currentUserEmail');
                currentUser = null;
                showLoginScreen();
                showNotification('Вы вышли из системы', 'warning');
            }
        }

        // ==================== УВЕДОМЛЕНИЯ ====================
        
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== СТАТИСТИКА ====================
        
        function updateStats() {
            if (!currentUser) return;
            
            let workoutsCount = 0;
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            if (currentUser.calendar && currentUser.calendar[monthKey]) {
                workoutsCount = Object.values(currentUser.calendar[monthKey]).filter(
                    status => status === 'trained'
                ).length;
            }
            
            const goalsTotal = currentUser.goals ? currentUser.goals.length : 0;
            const goalsCompleted = currentUser.goals ? 
                currentUser.goals.filter(goal => goal.completed).length : 0;
            
            const friendsCount = currentUser.friends ? currentUser.friends.length : 0;
            
            document.getElementById('workoutsCount').textContent = workoutsCount;
            document.getElementById('goalsTotal').textContent = goalsTotal;
            document.getElementById('goalsCompleted').textContent = goalsCompleted;
            document.getElementById('friendsCount').textContent = friendsCount;
        }

        // ==================== SERVICE WORKER ФАЙЛ (динамически создаётся) ====================
        
        function createServiceWorker() {
            // Создаём файл service worker
            const swCode = `
                const CACHE_NAME = 'gymtracker-v1';
                const urlsToCache = [
                    '/',
                    '/index.html',
                    '/paint-background.jpg'
                ];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                    );
                });

                self.addEventListener('activate', event => {
                    const cacheWhitelist = [CACHE_NAME];
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheWhitelist.indexOf(cacheName) === -1) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                });
            `;
            
            // Создаём blob URL для service worker
            const swBlob = new Blob([swCode], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);
            
            // Если service worker уже зарегистрирован, обновляем его
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration) {
                        registration.unregister().then(() => {
                            navigator.serviceWorker.register(swURL);
                        });
                    } else {
                        navigator.serviceWorker.register(swURL);
                    }
                });
            }
        }
        
        // Создаём service worker при загрузке
        setTimeout(createServiceWorker, 1000);
    </script>
</body>
</html>
